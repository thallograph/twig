{"version":3,"file":"RateLimiter.js","names":["Context","_interopRequireWildcard","require","Duration","Effect","_Function","Layer","Schema","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","TypeId","exports","RateLimiter","GenericTag","make","gen","store","RateLimiterStore","identity","consume","options","tokens","onExceeded","algorithm","window","decode","windowMillis","toMillis","refillRate","unsafeDivide","limit","refillRateMillis","fail","RateLimitExceeded","key","retryAfter","remaining","succeed","delay","resetAfter","flatMap","fixedWindow","undefined","count","ttl","millis","zero","ttlTotal","elapsed","windowNumber","Math","floor","times","ceil","tokenBucket","allowOverflow","layer","effect","makeWithRateLimiter","map","limiter","isZero","makeSleep","result","as","sleep","ErrorTypeId","TaggedError","DurationFromMillis","String","Number","reason","message","RateLimitStoreError","cause","optional","Defect","RateLimiterError","Union","Tag","layerStoreMemory","sync","fixedCounters","Map","tokenBuckets","of","clockWith","clock","now","unsafeCurrentTimeMillis","counter","expiresAt","bucket","lastRefill","tokensToAdd","min","newTokenCount"],"sources":["../../src/RateLimiter.ts"],"sourcesContent":[null],"mappings":";;;;;;AAGA,IAAAA,OAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,QAAA,GAAAF,uBAAA,CAAAC,OAAA;AACA,IAAAE,MAAA,GAAAH,uBAAA,CAAAC,OAAA;AACA,IAAAG,SAAA,GAAAH,OAAA;AACA,IAAAI,KAAA,GAAAL,uBAAA,CAAAC,OAAA;AACA,IAAAK,MAAA,GAAAN,uBAAA,CAAAC,OAAA;AAAuC,SAAAD,wBAAAO,CAAA,EAAAC,CAAA,6BAAAC,OAAA,MAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAT,uBAAA,YAAAA,CAAAO,CAAA,EAAAC,CAAA,SAAAA,CAAA,IAAAD,CAAA,IAAAA,CAAA,CAAAK,UAAA,SAAAL,CAAA,MAAAM,CAAA,EAAAC,CAAA,EAAAC,CAAA,KAAAC,SAAA,QAAAC,OAAA,EAAAV,CAAA,iBAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,SAAAQ,CAAA,MAAAF,CAAA,GAAAL,CAAA,GAAAG,CAAA,GAAAD,CAAA,QAAAG,CAAA,CAAAK,GAAA,CAAAX,CAAA,UAAAM,CAAA,CAAAM,GAAA,CAAAZ,CAAA,GAAAM,CAAA,CAAAO,GAAA,CAAAb,CAAA,EAAAQ,CAAA,gBAAAP,CAAA,IAAAD,CAAA,gBAAAC,CAAA,OAAAa,cAAA,CAAAC,IAAA,CAAAf,CAAA,EAAAC,CAAA,OAAAM,CAAA,IAAAD,CAAA,GAAAU,MAAA,CAAAC,cAAA,KAAAD,MAAA,CAAAE,wBAAA,CAAAlB,CAAA,EAAAC,CAAA,OAAAM,CAAA,CAAAK,GAAA,IAAAL,CAAA,CAAAM,GAAA,IAAAP,CAAA,CAAAE,CAAA,EAAAP,CAAA,EAAAM,CAAA,IAAAC,CAAA,CAAAP,CAAA,IAAAD,CAAA,CAAAC,CAAA,WAAAO,CAAA,KAAAR,CAAA,EAAAC,CAAA;AARvC;;;;AAUA;;;;AAIO,MAAMkB,MAAM,GAAAC,OAAA,CAAAD,MAAA,GAAW,mCAAmC;AAyBjE;;;;AAIO,MAAME,WAAW,GAAAD,OAAA,CAAAC,WAAA,gBAA0C7B,OAAO,CAAC8B,UAAU,CAAcH,MAAM,CAAC;AAEzG;;;;AAIO,MAAMI,IAAI,GAAAH,OAAA,CAAAG,IAAA,gBAIb3B,MAAM,CAAC4B,GAAG,CAAC,aAAS;EACtB,MAAMC,KAAK,GAAG,OAAOC,gBAAgB;EAErC,OAAO,IAAAC,kBAAQ,EAAc;IAC3B,CAACR,MAAM,GAAGA,MAAM;IAChBS,OAAOA,CAACC,OAAO;MACb,MAAMC,MAAM,GAAGD,OAAO,CAACC,MAAM,IAAI,CAAC;MAClC,MAAMC,UAAU,GAAGF,OAAO,CAACE,UAAU,IAAI,MAAM;MAC/C,MAAMC,SAAS,GAAGH,OAAO,CAACG,SAAS,IAAI,cAAc;MACrD,MAAMC,MAAM,GAAGtC,QAAQ,CAACuC,MAAM,CAACL,OAAO,CAACI,MAAM,CAAC;MAC9C,MAAME,YAAY,GAAGxC,QAAQ,CAACyC,QAAQ,CAACH,MAAM,CAAC;MAC9C,MAAMI,UAAU,GAAG1C,QAAQ,CAAC2C,YAAY,CAACL,MAAM,EAAEJ,OAAO,CAACU,KAAK,CAAC;MAC/D,MAAMC,gBAAgB,GAAG7C,QAAQ,CAACyC,QAAQ,CAACC,UAAU,CAAC;MAEtD,IAAIP,MAAM,GAAGD,OAAO,CAACU,KAAK,EAAE;QAC1B,OAAOR,UAAU,KAAK,MAAM,GACxBnC,MAAM,CAAC6C,IAAI,CACX,IAAIC,iBAAiB,CAAC;UACpBC,GAAG,EAAEd,OAAO,CAACc,GAAG;UAChBC,UAAU,EAAEX,MAAM;UAClBM,KAAK,EAAEV,OAAO,CAACU,KAAK;UACpBM,SAAS,EAAE;SACZ,CAAC,CACH,GACCjD,MAAM,CAACkD,OAAO,CAAgB;UAC9BC,KAAK,EAAEd,MAAM;UACbM,KAAK,EAAEV,OAAO,CAACU,KAAK;UACpBM,SAAS,EAAE,CAAC;UACZG,UAAU,EAAEf;SACb,CAAC;MACN;MAEA,IAAID,SAAS,KAAK,cAAc,EAAE;QAChC,OAAOpC,MAAM,CAACqD,OAAO,CACnBxB,KAAK,CAACyB,WAAW,CAAC;UAChBP,GAAG,EAAEd,OAAO,CAACc,GAAG;UAChBb,MAAM;UACNO,UAAU;UACVE,KAAK,EAAER,UAAU,KAAK,MAAM,GAAGF,OAAO,CAACU,KAAK,GAAGY;SAChD,CAAC,EACF,CAAC,CAACC,KAAK,EAAEC,GAAG,CAAC,KAAI;UACf,IAAItB,UAAU,KAAK,MAAM,EAAE;YACzB,MAAMc,SAAS,GAAGhB,OAAO,CAACU,KAAK,GAAGa,KAAK;YACvC,IAAIP,SAAS,GAAG,CAAC,EAAE;cACjB,OAAOjD,MAAM,CAAC6C,IAAI,CAChB,IAAIC,iBAAiB,CAAC;gBACpBC,GAAG,EAAEd,OAAO,CAACc,GAAG;gBAChBC,UAAU,EAAEjD,QAAQ,CAAC2D,MAAM,CAACD,GAAG,CAAC;gBAChCd,KAAK,EAAEV,OAAO,CAACU,KAAK;gBACpBM,SAAS,EAAE;eACZ,CAAC,CACH;YACH;YACA,OAAOjD,MAAM,CAACkD,OAAO,CAAgB;cACnCC,KAAK,EAAEpD,QAAQ,CAAC4D,IAAI;cACpBhB,KAAK,EAAEV,OAAO,CAACU,KAAK;cACpBM,SAAS;cACTG,UAAU,EAAErD,QAAQ,CAAC2D,MAAM,CAACD,GAAG;aAChC,CAAC;UACJ;UACA,MAAMG,QAAQ,GAAGJ,KAAK,GAAGZ,gBAAgB;UACzC,MAAMiB,OAAO,GAAGD,QAAQ,GAAGH,GAAG;UAC9B,MAAMK,YAAY,GAAGC,IAAI,CAACC,KAAK,CAAC,CAACR,KAAK,GAAG,CAAC,IAAIvB,OAAO,CAACU,KAAK,CAAC;UAC5D,MAAMM,SAAS,GAAIa,YAAY,GAAGvB,YAAY,GAAIsB,OAAO;UACzD,MAAMV,KAAK,GAAGF,SAAS,IAAI,CAAC,GAAGlD,QAAQ,CAAC4D,IAAI,GAAG5D,QAAQ,CAAC2D,MAAM,CAACT,SAAS,CAAC;UACzE,OAAOjD,MAAM,CAACkD,OAAO,CAAgB;YACnCC,KAAK;YACLR,KAAK,EAAEV,OAAO,CAACU,KAAK;YACpBM,SAAS,EAAEhB,OAAO,CAACU,KAAK,GAAGa,KAAK;YAChCJ,UAAU,EAAErD,QAAQ,CAACkE,KAAK,CAAC5B,MAAM,EAAE0B,IAAI,CAACG,IAAI,CAACT,GAAG,GAAGlB,YAAY,CAAC;WACjE,CAAC;QACJ,CAAC,CACF;MACH;MAEA,OAAOvC,MAAM,CAACqD,OAAO,CACnBxB,KAAK,CAACsC,WAAW,CAAC;QAChBpB,GAAG,EAAEd,OAAO,CAACc,GAAG;QAChBb,MAAM;QACNS,KAAK,EAAEV,OAAO,CAACU,KAAK;QACpBF,UAAU;QACV2B,aAAa,EAAEjC,UAAU,KAAK;OAC/B,CAAC,EACDc,SAAS,IAAI;QACZ,IAAId,UAAU,KAAK,MAAM,EAAE;UACzB,IAAIc,SAAS,GAAG,CAAC,EAAE;YACjB,OAAOjD,MAAM,CAAC6C,IAAI,CAChB,IAAIC,iBAAiB,CAAC;cACpBC,GAAG,EAAEd,OAAO,CAACc,GAAG;cAChBC,UAAU,EAAEjD,QAAQ,CAACkE,KAAK,CAACxB,UAAU,EAAE,CAACQ,SAAS,CAAC;cAClDN,KAAK,EAAEV,OAAO,CAACU,KAAK;cACpBM,SAAS,EAAE;aACZ,CAAC,CACH;UACH;UACA,OAAOjD,MAAM,CAACkD,OAAO,CAAgB;YACnCC,KAAK,EAAEpD,QAAQ,CAAC4D,IAAI;YACpBhB,KAAK,EAAEV,OAAO,CAACU,KAAK;YACpBM,SAAS;YACTG,UAAU,EAAErD,QAAQ,CAACkE,KAAK,CAACxB,UAAU,EAAER,OAAO,CAACU,KAAK,GAAGM,SAAS;WACjE,CAAC;QACJ;QACA,IAAIA,SAAS,IAAI,CAAC,EAAE;UAClB,OAAOjD,MAAM,CAACkD,OAAO,CAAgB;YACnCC,KAAK,EAAEpD,QAAQ,CAAC4D,IAAI;YACpBhB,KAAK,EAAEV,OAAO,CAACU,KAAK;YACpBM,SAAS;YACTG,UAAU,EAAErD,QAAQ,CAACkE,KAAK,CAACxB,UAAU,EAAER,OAAO,CAACU,KAAK,GAAGM,SAAS;WACjE,CAAC;QACJ;QACA,OAAOjD,MAAM,CAACkD,OAAO,CAAgB;UACnCC,KAAK,EAAEpD,QAAQ,CAACkE,KAAK,CAACxB,UAAU,EAAE,CAACQ,SAAS,CAAC;UAC7CN,KAAK,EAAEV,OAAO,CAACU,KAAK;UACpBM,SAAS;UACTG,UAAU,EAAErD,QAAQ,CAACkE,KAAK,CAACxB,UAAU,EAAER,OAAO,CAACU,KAAK,GAAGM,SAAS;SACjE,CAAC;MACJ,CAAC,CACF;IACH;GACD,CAAC;AACJ,CAAC,CAAC;AAEF;;;;AAIO,MAAMoB,KAAK,GAAA7C,OAAA,CAAA6C,KAAA,gBAIdnE,KAAK,CAACoE,MAAM,CAAC7C,WAAW,EAAEE,IAAI,CAAC;AAEnC;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2BO,MAAM4C,mBAAmB,GAAA/C,OAAA,CAAA+C,mBAAA,gBAW5BvE,MAAM,CAACwE,GAAG,CACZ/C,WAAW,EACVgD,OAAO,IAAMxC,OAAO,IAAMqC,MAAM,IAC/BtE,MAAM,CAACqD,OAAO,CAACoB,OAAO,CAACzC,OAAO,CAACC,OAAO,CAAC,EAAE,CAAC;EAAEkB;AAAK,CAAE,KAAI;EACrD,IAAIpD,QAAQ,CAAC2E,MAAM,CAACvB,KAAK,CAAC,EAAE,OAAOmB,MAAM;EACzC,OAAOtE,MAAM,CAACmD,KAAK,CAACmB,MAAM,EAAEnB,KAAK,CAAC;AACpC,CAAC,CAAC,CACL;AAED;;;;;;;;;;;;;;;;;;;;;;;;;AAyBO,MAAMwB,SAAS,GAAAnD,OAAA,CAAAmD,SAAA,gBAUlB3E,MAAM,CAACwE,GAAG,CACZ/C,WAAW,EACVgD,OAAO,IAAMxC,OAAO,IACnBjC,MAAM,CAACqD,OAAO,CACZoB,OAAO,CAACzC,OAAO,CAAC;EACd,GAAGC,OAAO;EACVE,UAAU,EAAE;CACb,CAAsD,EACtDyC,MAAM,IAAI;EACT,IAAI7E,QAAQ,CAAC2E,MAAM,CAACE,MAAM,CAACzB,KAAK,CAAC,EAAE,OAAOnD,MAAM,CAACkD,OAAO,CAAC0B,MAAM,CAAC;EAChE,OAAO5E,MAAM,CAAC6E,EAAE,CAAC7E,MAAM,CAAC8E,KAAK,CAACF,MAAM,CAACzB,KAAK,CAAC,EAAEyB,MAAM,CAAC;AACtD,CAAC,CACF,CACJ;AAED;;;;AAIO,MAAMG,WAAW,GAAAvD,OAAA,CAAAuD,WAAA,GAAgB,oDAAoD;AAQ5F;;;;AAIM,MAAOjC,iBAAkB,sBAAQ3C,MAAM,CAAC6E,WAAW,CACvD,oDAAoD,CACrD,CAAC,kBAAkB,EAAE;EACpBhC,UAAU,EAAE7C,MAAM,CAAC8E,kBAAkB;EACrClC,GAAG,EAAE5C,MAAM,CAAC+E,MAAM;EAClBvC,KAAK,EAAExC,MAAM,CAACgF,MAAM;EACpBlC,SAAS,EAAE9C,MAAM,CAACgF;CACnB,CAAC;EACA;;;EAGS,CAACJ,WAAW,IAAiBA,WAAW;EAEjD;;;EAGSK,MAAM,GAAG,UAAU;EAE5B;;;EAGA,IAAIC,OAAOA,CAAA;IACT,OAAO,qBAAqB;EAC9B;;AAGF;;;;AAAA7D,OAAA,CAAAsB,iBAAA,GAAAA,iBAAA;AAIM,MAAOwC,mBAAoB,sBAAQnF,MAAM,CAAC6E,WAAW,CACzD,sDAAsD,CACvD,CAAC,kBAAkB,EAAE;EACpBK,OAAO,EAAElF,MAAM,CAAC+E,MAAM;EACtBK,KAAK,eAAEpF,MAAM,CAACqF,QAAQ,CAACrF,MAAM,CAACsF,MAAM;CACrC,CAAC;EACA;;;EAGS,CAACV,WAAW,IAAiBA,WAAW;EAEjD;;;EAGSK,MAAM,GAAG,YAAY;;AAGhC;;;;AAAA5D,OAAA,CAAA8D,mBAAA,GAAAA,mBAAA;AAIO,MAAMI,gBAAgB,GAAAlE,OAAA,CAAAkE,gBAAA,gBAAGvF,MAAM,CAACwF,KAAK,CAAC7C,iBAAiB,EAAEwC,mBAAmB,CAAC;AAqCpF;;;;AAIM,MAAOxD,gBAAiB,sBAAQlC,OAAO,CAACgG,GAAG,CAAC,mDAAmD,CAAC,EAsCnG;AAEH;;;;AAAApE,OAAA,CAAAM,gBAAA,GAAAA,gBAAA;AAIO,MAAM+D,gBAAgB,GAAArE,OAAA,CAAAqE,gBAAA,gBAEzB3F,KAAK,CAAC4F,IAAI,CAAChE,gBAAgB,EAAE,MAAK;EACpC,MAAMiE,aAAa,GAAG,IAAIC,GAAG,EAAgD;EAC7E,MAAMC,YAAY,GAAG,IAAID,GAAG,EAAkD;EAE9E,OAAOlE,gBAAgB,CAACoE,EAAE,CAAC;IACzB5C,WAAW,EAAGrB,OAAO,IACnBjC,MAAM,CAACmG,SAAS,CAAEC,KAAK,IACrBpG,MAAM,CAAC8F,IAAI,CAAC,MAAK;MACf,MAAMlD,gBAAgB,GAAG7C,QAAQ,CAACyC,QAAQ,CAACP,OAAO,CAACQ,UAAU,CAAC;MAC9D,MAAM4D,GAAG,GAAGD,KAAK,CAACE,uBAAuB,EAAE;MAC3C,IAAIC,OAAO,GAAGR,aAAa,CAAC/E,GAAG,CAACiB,OAAO,CAACc,GAAG,CAAC;MAC5C,IAAI,CAACwD,OAAO,IAAIA,OAAO,CAACC,SAAS,IAAIH,GAAG,EAAE;QACxCE,OAAO,GAAG;UAAE/C,KAAK,EAAE,CAAC;UAAEgD,SAAS,EAAEH;QAAG,CAAE;QACtCN,aAAa,CAAC9E,GAAG,CAACgB,OAAO,CAACc,GAAG,EAAEwD,OAAO,CAAC;MACzC;MACA,IAAItE,OAAO,CAACU,KAAK,IAAI4D,OAAO,CAAC/C,KAAK,GAAGvB,OAAO,CAACC,MAAM,GAAGD,OAAO,CAACU,KAAK,EAAE;QACnE,OAAO,CAAC4D,OAAO,CAAC/C,KAAK,GAAGvB,OAAO,CAACC,MAAM,EAAEqE,OAAO,CAACC,SAAS,GAAGH,GAAG,CAAU;MAC3E;MACAE,OAAO,CAAC/C,KAAK,IAAIvB,OAAO,CAACC,MAAM;MAC/BqE,OAAO,CAACC,SAAS,IAAI5D,gBAAgB,GAAGX,OAAO,CAACC,MAAM;MACtD,OAAO,CAACqE,OAAO,CAAC/C,KAAK,EAAE+C,OAAO,CAACC,SAAS,GAAGH,GAAG,CAAU;IAC1D,CAAC,CAAC,CACH;IACHlC,WAAW,EAAGlC,OAAO,IACnBjC,MAAM,CAACmG,SAAS,CAAEC,KAAK,IACrBpG,MAAM,CAAC8F,IAAI,CAAC,MAAK;MACf,MAAMlD,gBAAgB,GAAG7C,QAAQ,CAACyC,QAAQ,CAACP,OAAO,CAACQ,UAAU,CAAC;MAC9D,MAAM4D,GAAG,GAAGD,KAAK,CAACE,uBAAuB,EAAE;MAC3C,IAAIG,MAAM,GAAGR,YAAY,CAACjF,GAAG,CAACiB,OAAO,CAACc,GAAG,CAAC;MAC1C,IAAI,CAAC0D,MAAM,EAAE;QACXA,MAAM,GAAG;UAAEvE,MAAM,EAAED,OAAO,CAACU,KAAK;UAAE+D,UAAU,EAAEL;QAAG,CAAE;QACnDJ,YAAY,CAAChF,GAAG,CAACgB,OAAO,CAACc,GAAG,EAAE0D,MAAM,CAAC;MACvC,CAAC,MAAM;QACL,MAAM5C,OAAO,GAAGwC,GAAG,GAAGI,MAAM,CAACC,UAAU;QACvC,MAAMC,WAAW,GAAG5C,IAAI,CAACC,KAAK,CAACH,OAAO,GAAGjB,gBAAgB,CAAC;QAC1D,IAAI+D,WAAW,GAAG,CAAC,EAAE;UACnBF,MAAM,CAACvE,MAAM,GAAG6B,IAAI,CAAC6C,GAAG,CAAC3E,OAAO,CAACU,KAAK,EAAE8D,MAAM,CAACvE,MAAM,GAAGyE,WAAW,CAAC;UACpEF,MAAM,CAACC,UAAU,IAAIC,WAAW,GAAG/D,gBAAgB;QACrD;MACF;MAEA,MAAMiE,aAAa,GAAGJ,MAAM,CAACvE,MAAM,GAAGD,OAAO,CAACC,MAAM;MACpD,IAAID,OAAO,CAACmC,aAAa,IAAIyC,aAAa,IAAI,CAAC,EAAE;QAC/CJ,MAAM,CAACvE,MAAM,GAAG2E,aAAa;MAC/B;MACA,OAAOA,aAAa;IACtB,CAAC,CAAC;GAEP,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}